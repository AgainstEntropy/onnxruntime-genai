parameters:
  - name: DownloadCUDA
    type: boolean
    default: false
  - name: DownloadTRT
    type: boolean
    default: false
  - name: CudaVersion
    type: string
    default: '11.8'
    values:
      - '11.8'
      - '12.2'
  - name: TrtVersion
    type: string
    default: '10.0.1.6'
    values:
      - 8.6.1.6
      - 10.0.1.6

steps:
  - ${{ if eq(parameters.DownloadCUDA, true) }}:
    - powershell: |
        $env:AZCOPY_MSI_CLIENT_ID = "63b63039-6328-442f-954b-5a64d124e5b4";
        azcopy.exe cp --recursive https://lotusscus.blob.core.windows.net/models/cuda_sdk/v${{ parameters.CudaVersion }} $(Agent.TempDirectory)
      displayName: 'Download CUDA SDK v${{ parameters.CudaVersion }}'
    - powershell: |
        Write-Host "##vso[task.prependpath]$(Agent.TempDirectory)\v${{ parameters.CudaVersion }}\bin;$(Agent.TempDirectory)\v${{ parameters.CudaVersion }}\extras\CUPTI\lib64"
        $env:CUDA_PATH = "##vso[task.prependpath]$(Agent.TempDirectory)\v${{ parameters.CudaVersion }}"
      displayName: 'Append CUDA SDK Directory to PATH'

    - task: CmdLine@2
      inputs:
        script: |
          echo %PATH%
      displayName: 'Print PATH after download CUDA SDK'

    - task: CmdLine@2
      inputs:
        script: |
          echo %CUDA_PATH%
      displayName: 'Print CUDA_PATH'

  - ${{ if eq(parameters.DownloadTRT, true) }}:
    - ${{ if eq(parameters.CudaVersion, '11.8') }}:
        - bash: |
            echo "##vso[task.setvariable variable=trtCudaVersion]11.8"
          displayName: Set trtCudaVersion
    - ${{ if and(eq(parameters.CudaVersion, '12.2'), eq(parameters.TrtVersion, '8.6.1.6')) }}:
        - bash: |
            echo "##vso[task.setvariable variable=trtCudaVersion]12.0"
          displayName: Set trtCudaVersion
    - ${{ if and(eq(parameters.CudaVersion, '12.2'), eq(parameters.TrtVersion, '10.0.1.6')) }}:
        - bash: |
            echo "##vso[task.setvariable variable=trtCudaVersion]12.4"
          displayName: Set trtCudaVersion

    - bash: |
        echo $(trtCudaVersion) && echo TensorRT-${{ parameters.TrtVersion }}.Windows10.x86_64.cuda-$(trtCudaVersion)
      displayName: Get trtCudaVersion and Directory Name

    - powershell: |
        azcopy.exe cp --recursive https://lotusscus.blob.core.windows.net/models/local/TensorRT-${{ parameters.TrtVersion }}.Windows10.x86_64.cuda-$(trtCudaVersion) $(Agent.TempDirectory)
      displayName: 'Download TensorRT-${{ parameters.TrtVersion }}.Windows10.x86_64.cuda-$(trtCudaVersion)'

    - powershell: |
        Write-Host "##vso[task.prependpath]$(Agent.TempDirectory)\TensorRT-${{ parameters.TrtVersion }}.Windows10.x86_64.cuda-$(trtCudaVersion)\lib"
      displayName: 'Append TensorRT-${{ parameters.TrtVersion }} Directory to PATH'

    - task: CmdLine@2
      inputs:
        script: |
          echo %PATH%
      displayName: 'Print PATH after download TensorRT'
